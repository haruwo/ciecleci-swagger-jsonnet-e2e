"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const prism_http_1 = require("@stoplight/prism-http");
const chokidar = require("chokidar");
const os = require("os");
function runPrismAndSetupWatcher(createPrism, options) {
    return createPrism(options).then(possiblyServer => {
        if (possiblyServer) {
            let server = possiblyServer;
            const watcher = chokidar.watch(options.document, {
                persistent: os.platform() === 'darwin',
                disableGlobbing: true,
                awaitWriteFinish: { stabilityThreshold: 500, pollInterval: 100 },
            });
            watcher.on('change', () => {
                server.fastify.log.info('Restarting Prism...');
                prism_http_1.getHttpOperationsFromResource(options.document)
                    .then(operations => {
                    if (operations.length === 0) {
                        server.fastify.log.info('No operations found in the current file, continuing with the previously loaded spec.');
                    }
                    else {
                        return server.fastify
                            .close()
                            .then(() => {
                            server.fastify.log.info('Loading the updated operations...');
                            return createPrism(options);
                        })
                            .then(newServer => {
                            if (newServer) {
                                server = newServer;
                            }
                        });
                    }
                })
                    .catch(() => {
                    server.fastify.log.info('Something went terribly wrong, trying to start Prism with the original document.');
                    return server.fastify
                        .close()
                        .then(() => createPrism(options))
                        .catch(() => process.exit(1));
                });
            });
            return new Promise(resolve => watcher.once('ready', resolve));
        }
    });
}
exports.runPrismAndSetupWatcher = runPrismAndSetupWatcher;
