import{createScanner as e,findNodeAtOffset as r,getNodePath as n,visit as t,printParseErrorCode as i}from"jsonc-parser";import{DiagnosticSeverity as o}from"@stoplight/types";import a from"safe-stable-stringify";import{trimStart as s}from"lodash";const c=(e,r,n)=>{const t=e.toString();let i="",o=t,a=0,s=o.indexOf(r);for(;s>-1;)i+=t.substring(a,a+s)+n,o=o.substring(s+r.length,o.length),a+=s+r.length,s=o.indexOf(r);return o.length>0&&(i+=t.substring(t.length-o.length,t.length)),i},u=e=>c(c(decodeURIComponent(""+e),"~1","/"),"~0","~"),f=e=>c(c(e,"~1","/"),"~0","~"),l=e=>c(c(e,"~","~0"),"//","/~1"),p=e=>"number"==typeof e?e:c(c(e,"~","~0"),"/","~1"),h=r=>{const n=e(r,!0);if(n.scan(),1!==n.getToken())return;if(n.scan(),2===n.getToken())return;if(10!==n.getToken())throw new SyntaxError("Unexpected character");const t=n.getTokenValue();if(n.scan(),6!==n.getToken())throw new SyntaxError("Colon expected");switch(n.scan(),n.getToken()){case 10:return[t,n.getTokenValue()];case 11:return[t,Number(n.getTokenValue())];case 8:return[t,!0];case 9:return[t,!1];case 7:return[t,null];case 16:throw new SyntaxError("Unexpected character");case 17:throw new SyntaxError("Unexpected end of file");default:return}},g=({lineMap:e,ast:t},i)=>{const o=e[i.line],a=e[i.line+1];if(void 0===o)return;const s=r(t,void 0===a?o+i.character:Math.min(a,o+i.character),!0);if(void 0===s)return;const c=n(s);return 0!==c.length?c:void 0};function y(e){return f(e.split("/").pop()||"")}const d=({lineMap:e,ast:r},n,t=!1)=>{const i=function(e,r,n){e:for(const t of r){const r=Number.isInteger(Number(t))?Number(t):t;if("string"==typeof r||"number"==typeof r&&"array"!==e.type){if("object"!==e.type||!Array.isArray(e.children))return n?e:void 0;for(const n of e.children)if(Array.isArray(n.children)&&n.children[0].value===String(r)){e=n.children[1];continue e}return n?e:void 0}if("array"!==e.type||r<0||!Array.isArray(e.children)||r>=e.children.length)return n?e:void 0;e=e.children[r]}return e}(r,n,t);if(void 0!==i&&void 0!==i.range)return{range:i.range}};const m=(e,r={disallowComments:!0})=>{const n=[],{ast:t,data:i,lineMap:o}=v(e,n,r);return{data:i,diagnostics:n,ast:t,lineMap:o}},b=Symbol("object_keys"),w={ownKeys:e=>e[b]};function v(e,r=[],n){const a=N(e);let s={type:"array",offset:-1,length:-1,children:[],parent:void 0},c=null,u=[];const f=new WeakMap,l=[];function p(e){"property"===s.type&&(s.length=e-s.offset,s=s.parent)}function h(e,r,n){return{start:{line:e,character:r},end:{line:e,character:r+n}}}function g(e){return s.children.push(e),e}function y(e){Array.isArray(u)?u.push(e):null!==c&&(u[c]=e)}function d(e){y(e),l.push(u),u=e,c=null}function m(){b in u&&u[b].push(b),u=l.pop()}t(e,{onObjectBegin:(e,r,t,i)=>{s=g({type:"object",offset:e,length:-1,parent:s,children:[],range:h(t,i,r)}),!1===n.ignoreDuplicateKeys&&f.set(s,[]),d(function(e){if(e){const e=new Proxy({},w);return Reflect.defineProperty(e,b,{value:[]}),e}return{}}(!0===n.preserveKeyOrder))},onObjectProperty:(e,t,i,a,l)=>{if((s=g({type:"property",offset:t,length:-1,parent:s,children:[]})).children.push({type:"string",value:e,offset:t,length:i,parent:s}),!1===n.ignoreDuplicateKeys){const n=f.get(s.parent);n&&(0!==n.length&&n.includes(e)?r.push({range:h(a,l,i),message:"DuplicateKey",severity:o.Error,path:x(s),code:20}):n.push(e))}!0===n.preserveKeyOrder&&b in u&&function(e,r){const n=r in e?e[b].indexOf(r):-1;-1!==n&&e[b].splice(n,1);e[b].push(r)}(u,e),c=e},onObjectEnd:(e,r,t,i)=>{!1===n.ignoreDuplicateKeys&&f.delete(s),s.length=e+r-s.offset,s.range&&(s.range.end.line=t,s.range.end.character=i+r),s=s.parent,p(e+r),m()},onArrayBegin:(e,r,n,t)=>{s=g({type:"array",offset:e,length:-1,parent:s,children:[],range:h(n,t,r)}),d([])},onArrayEnd:(e,r,n,t)=>{s.length=e+r-s.offset,s.range&&(s.range.end.line=n,s.range.end.character=t+r),s=s.parent,p(e+r),m()},onLiteralValue:(e,r,n,t,i)=>{g({type:O(e),offset:r,length:n,parent:s,value:e,range:h(t,i,n)}),p(r+n),y(e)},onSeparator:(e,r,n)=>{"property"===s.type&&(":"===e?s.colonOffset=r:","===e&&p(r))},onError:(e,n,t,a,s)=>{r.push({range:h(a,s,t),message:i(e),severity:o.Error,code:e})}},n);const v=s.children[0];return v&&delete v.parent,{ast:v,data:u[0],lineMap:a}}function O(e){switch(typeof e){case"boolean":return"boolean";case"number":return"number";case"string":return"string";default:return"null"}}const N=e=>{const r=[0];let n=0;for(;n<e.length;n++)"\n"===e[n]&&r.push(n+1);return r.push(n+1),r};function x(e,r=[]){return"property"===e.type&&r.unshift(e.children[0].value),void 0!==e.parent?("array"===e.parent.type&&void 0!==e.parent.parent&&r.unshift(e.parent.children.indexOf(e)),x(e.parent,r)):r}const A=e=>S(e),S=e=>{if(e&&"object"!=typeof e)throw new TypeError("Invalid type: path must be an array of segments.");return 0===e.length?"#":`#/${e.map(p).join("/")}`},E=e=>j(e),j=e=>{if("string"!=typeof e)throw new TypeError("Invalid type: JSON Pointers are represented as strings.");if(0===e.length||"#"!==e[0])throw new URIError("Invalid JSON Pointer syntax; URI fragment identifiers must begin with a hash.");if(1===e.length)return[];if("/"!==e[1])throw new URIError("Invalid JSON Pointer syntax.");return(e=>{const r=e.length,n=[];let t=-1;for(;++t<r;)n.push(u(e[t]));return n})(e.substring(2).split("/"))},k=(e,r,n)=>{if(!e||!Object.hasOwnProperty.call(e,r)||r===n)return e;const t={};for(const[i,o]of Object.entries(e))i===r?t[n]=o:i in t||(t[i]=o);return t},I=(e,r)=>{if("string"!=typeof e)return e;try{const n=T(e);return"string"==typeof n?n:JSON.parse(e,r)}catch(e){return}},T=e=>{const r=Number(e);return Number.isFinite(r)?String(r)===e?r:e:NaN},P=(e,r,n)=>{if("string"==typeof e)return e;try{return JSON.stringify(e,r,n)}catch(t){return a(e,r,n)}},K=(e,r)=>{if(e instanceof Array){if(r instanceof Array){if(r.length>e.length)return!1;for(const n in r){if(!r.hasOwnProperty(n))continue;const t=parseInt(e[n]),i=parseInt(r[n]);if(isNaN(t)&&isNaN(i)){if(e[n]!==r[n])return!1}else if(t!==i)return!1}}}else{if("string"!=typeof e)return!1;if("string"==typeof r)return e.startsWith(r)}return!0};function M(e){return e.replace(/^(\/|#\/)/,"").split("/").map(f).map(U).join(".")}function U(e){return e.includes(".")?`["${e.replace(/"/g,'\\"')}"]`:e}function J(e,r){if("string"==typeof e&&"string"==typeof r)return s(e,r);if(!(e&&Array.isArray(e)&&e.length&&r&&Array.isArray(r)&&r.length))return e;let n=0;for(const t in e)if(e.hasOwnProperty(t)){if(e[t]!==r[t])break;n++}return e.slice(n)}export{u as decodePointer,f as decodePointerFragment,l as encodePointer,p as encodePointerFragment,h as getFirstPrimitiveProperty,g as getJsonPathForPosition,y as getLastPathSegment,d as getLocationForJsonPath,v as parseTree,m as parseWithPointers,A as pathToPointer,E as pointerToPath,k as renameObjectKey,I as safeParse,P as safeStringify,K as startsWith,M as toPropertyPath,J as trimStart};
